<!DOCTYPE html>
<html>
<head>
    <title>WikiRadio v1.2</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <style>
        body { background-color: #008080; font-family: "Times New Roman"; padding: 20px; text-align: center; }
        .window { background: #c0c0c0; border: 3px outset #fff; padding: 10px; box-shadow: 5px 5px 0px #000; max-width: 400px; margin: auto; }
        .title-bar { background: #000080; color: white; padding: 5px; font-weight: bold; text-align: left; margin-bottom: 10px; }
        button { background: #c0c0c0; border: 2px outset #fff; padding: 10px; margin: 5px; font-weight: bold; cursor: pointer; }
        input, select { padding: 10px; width: 85%; border: 2px inset #fff; margin-bottom: 10px; font-size: 16px; }
        .hidden { display: none; }
        marquee { background: #000; color: #0f0; padding: 10px; display: block; font-family: monospace; border: 2px inset #808080; }
        .blink { animation: blinker 1s linear infinite; color: red; font-weight: bold; }
        @keyframes blinker { 50% { opacity: 0; } }
        #savedList, #favList { margin-top: 10px; font-size: 12px; text-align: left; background: #e0e0e0; padding: 5px; border: 1px inset #fff; }
    </style>
</head>
<body>
    <div class="window">
        <div class="title-bar">WikiRadio_v1.2.exe</div>
        <h1 style="margin:0;">üìª WIKI-RADIO</h1>
        <p id="liveStatus" class="blink">** STANDBY **</p>
        
        <div id="step1">
            <input type="text" id="topicInput" placeholder="Topic (e.g. Punk rock)">
            <button onclick="searchAndFindCategories()" style="width:100%">SCAN FREQUENCIES</button>
            <div id="savedList"></div>
            <div id="favList"></div>
        </div>

        <div id="step2" class="hidden">
            <p>Station Found!</p>
            <select id="categorySelect"></select>
            <button onclick="startRadio()" style="background:#00ff00;">START RADIO</button>
            <button onclick="saveCurrentStation()">SAVE STATION PRESET</button>
            <button onclick="resetApp()">BACK</button>
        </div>

        <div id="step3" class="hidden">
            <marquee id="nowPlaying">TUNING...</marquee>
            <button onclick="favoriteCurrentArticle()" style="background:#f1c40f; color: black; width:100%;">‚≠ê FAVORITE THIS ARTICLE</button>
            <button onclick="nextArticle()" style="width:100%; height:80px; font-size:24px; margin-top:10px;">SKIP >></button>
            <button onclick="stopRadio()" style="margin-top:20px; width:100%">POWER OFF</button>
        </div>

        <div style="margin-top:20px; font-size:12px; text-align:left;">
            <details>
                <summary>Hardware Settings</summary>
                Voice: <select id="voiceSelect" onchange="updateSettings()"></select><br>
                Speed: <input type="range" id="rateRange" min="0.5" max="2" step="0.1" value="1.1" oninput="updateSettings()">
            </details>
        </div>
    </div>

    <audio id="silenceLoop" loop src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==" style="display:none;"></audio>

    <script>
        let articleList = [];
        let currentArticleTitle = "";
        const synth = window.speechSynthesis;
        let voices = [];
        let voiceSettings = { index: 0, rate: 1.1 };
        let wakeLock = null;

        document.addEventListener('DOMContentLoaded', () => {
            updateSavedUI();
            updateFavUI();
            loadVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) { speechSynthesis.onvoiceschanged = loadVoices; }
            if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js'); }
        });

        function loadVoices() {
            voices = synth.getVoices();
            const voiceSelect = document.getElementById('voiceSelect');
            if (!voiceSelect) return;
            voiceSelect.innerHTML = '';
            voices.forEach((v, i) => {
                const opt = document.createElement('option');
                opt.value = i; opt.textContent = v.name;
                voiceSelect.appendChild(opt);
            });
        }

        function updateSettings() {
            voiceSettings.index = document.getElementById('voiceSelect').value;
            voiceSettings.rate = document.getElementById('rateRange').value;
        }

        function playStatic() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const buf = ctx.createBuffer(1, ctx.sampleRate * 0.3, ctx.sampleRate);
                const data = buf.getChannelData(0);
                for (let i = 0; i < buf.length; i++) data[i] = Math.random() * 2 - 1;
                const src = ctx.createBufferSource();
                const gn = ctx.createGain();
                src.buffer = buf; gn.gain.value = 0.05;
                src.connect(gn); gn.connect(ctx.destination);
                src.start();
            } catch(e) {}
        }

        async function searchAndFindCategories() {
            const input = document.getElementById('topicInput').value;
            if (!input) return;
            const sRes = await fetch(`https://en.wikipedia.org/w/api.php?action=opensearch&search=${encodeURIComponent(input)}&limit=1&namespace=0&format=json&origin=*`);
            const sData = await sRes.json();
            if (!sData[1].length) return alert("No stations found!");
            const correctTitle = sData[1][0];
            const cRes = await fetch(`https://en.wikipedia.org/w/api.php?action=query&prop=categories&titles=${encodeURIComponent(correctTitle)}&cllimit=20&format=json&origin=*`);
            const cData = await cRes.json();
            const pId = Object.keys(cData.query.pages)[0];
            const cats = cData.query.pages[pId].categories || [];
            const sel = document.getElementById('categorySelect');
            sel.innerHTML = '';
            if (!cats.length) return alert("No categories found.");
            cats.forEach(c => {
                const o = document.createElement('option');
                o.value = c.title; o.innerText = c.title.replace('Category:', '');
                sel.appendChild(o);
            });
            showStep(2);
        }

        async function startRadio() {
            const c = document.getElementById('categorySelect').value;
            const res = await fetch(`https://en.wikipedia.org/w/api.php?action=query&list=categorymembers&cmtitle=${encodeURIComponent(c)}&cmlimit=50&format=json&origin=*`);
            const d = await res.json();
            articleList = d.query.categorymembers.filter(a => a.ns === 0);
            showStep(3);
            setupMedia();
            nextArticle();
        }

        async function nextArticle() {
            playStatic();
            synth.cancel();
            if (!articleList.length) return;
            const art = articleList[Math.floor(Math.random() * articleList.length)];
            currentArticleTitle = art.title;
            document.getElementById('nowPlaying').innerText = "NOW PLAYING: " + art.title;
            const res = await fetch(`https://en.wikipedia.org/w/api.php?action=query&prop=extracts&exintro&explaintext&titles=${encodeURIComponent(art.title)}&format=json&origin=*`);
            const d = await res.json();
            const txt = d.query.pages[Object.keys(d.query.pages)[0]].extract;
            const ut = new SpeechSynthesisUtterance(txt || "Empty article.");
            ut.voice = voices[voiceSettings.index];
            ut.rate = voiceSettings.rate;
            ut.onend = nextArticle;
            synth.speak(ut);
        }

        async function setupMedia() {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.setActionHandler('nexttrack', nextArticle);
                document.getElementById('silenceLoop').play().catch(e => {});
            }
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (err) {}
        }

        function favoriteCurrentArticle() {
            if (!currentArticleTitle) return;
            let favs = JSON.parse(localStorage.getItem('wikiFavs') || "[]");
            if (!favs.includes(currentArticleTitle)) {
                favs.push(currentArticleTitle);
                localStorage.setItem('wikiFavs', JSON.stringify(favs));
                updateFavUI();
                alert("Article Star
