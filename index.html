<!DOCTYPE html>
<html>
<head>
    <title>WIKIRADIO - THE BEST PAGE ON THE WEB!</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <style>
        body { 
            background: #000000 url('https://www.transparenttextures.com/patterns/stardust.png'); 
            color: #00FF00; 
            font-family: "Courier New", Courier, monospace; 
            padding: 10px;
        }
        .main-container {
            border: 4px ridge #ff00ff;
            background: #000080;
            padding: 15px;
            max-width: 500px;
            margin: auto;
            box-shadow: 10px 10px 0px #ff0000;
        }
        h1 { 
            color: #ffff00; 
            text-shadow: 2px 2px #ff0000; 
            font-style: italic;
            text-decoration: underline;
        }
        button { 
            background: #00ffff; 
            color: #000; 
            border: 3px outset #fff; 
            font-weight: bold; 
            padding: 10px;
            margin: 5px;
            cursor: pointer;
            text-transform: uppercase;
        }
        button:active { border: 3px inset #fff; }
        input, select { 
            background: #fff; 
            color: #000; 
            border: 3px inset #808080;
            width: 90%;
            font-weight: bold;
        }
        .hidden { display: none; }
        marquee { 
            border: 2px solid #fff; 
            background: #000; 
            padding: 5px; 
            color: #00ffff;
            font-weight: bold;
        }
        .blink { animation: blinker 0.8s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
        
        .nav-link { color: #ff00ff; font-size: 12px; }
        #favList a { color: #ffff00; }
        .guestbook { border-top: 2px dashed #00ff00; margin-top: 20px; padding-top: 10px; font-size: 10px; }
    </style>
</head>
<body>
    <center>
        <img src="https://web.archive.org/web/20090830050117/http://geocities.com/Heartland/Acres/1314/anim_welcome.gif" width="200"><br>
        <div class="main-container">
            <h1>~* WikiRadio *~</h1>
            <img src="https://web.archive.org/web/20091022131336/http://geocities.com/SoHo/6616/undercon.gif" width="50">
            <p class="blink" style="color: #ff0000;">!! NEW ARTICLES EVERY MINUTE !!</p>
            
            <div id="step1">
                <p>SEARCH FOR A TOPIC:</p>
                <input type="text" id="topicInput" placeholder="ex: Heavy Metal">
                <button onclick="searchAndFindCategories()">[ CLICK TO SCAN ]</button>
                <div id="savedList"></div>
                <div id="favList"></div>
            </div>

            <div id="step2" class="hidden">
                <p style="color: #ffff00;">STATION FOUND! PICK A CHANNEL:</p>
                <select id="categorySelect"></select>
                <button onclick="startRadio()">== PLAY ==</button>
                <button onclick="saveCurrentStation()">SAVE PRESET</button>
                <button onclick="resetApp()">GO BACK</button>
            </div>

            <div id="step3" class="hidden">
                <marquee id="nowPlaying" scrollamount="10">LOADING DATA FROM THE CYBERSPACE...</marquee>
                <div style="margin: 10px;">
                    <button onclick="favoriteCurrentArticle()" style="background: yellow;">[ STAR THIS ]</button>
                    <button onclick="nextArticle()" style="width:100%; height:80px; font-size:24px; background: #00ff00;">NEXT >>></button>
                </div>
                <button onclick="stopRadio()" style="background: red; color: white;">DISCONNECT</button>
            </div>

            <div class="guestbook">
                <details>
                    <summary>Voice Tuning [X]</summary>
                    Voice: <select id="voiceSelect" onchange="updateSettings()"></select><br>
                    Speed: <input type="range" id="rateRange" min="0.5" max="2" step="0.1" value="1.1" oninput="updateSettings()">
                </details>
                <br>
                <img src="https://web.archive.org/web/20090804104432/http://geocities.com/Athens/Olympus/1131/netscape.gif">
                <img src="https://web.archive.org/web/20091024032742/http://geocities.com/Hollywood/Hills/1410/ie_static.gif">
            </div>
        </div>
        <p class="nav-link">BEST VIEWED IN 800x600 RESOLUTION</p>
        <audio id="silenceLoop" loop src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==" style="display:none;"></audio>
    </center>

    <script>
        let articleList = [];
        let currentArticleTitle = "";
        const synth = window.speechSynthesis;
        let voices = [];
        let voiceSettings = { index: 0, rate: 1.1 };
        let wakeLock = null;

        document.addEventListener('DOMContentLoaded', () => {
            updateSavedUI(); updateFavUI(); loadVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) { speechSynthesis.onvoiceschanged = loadVoices; }
            if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js'); }
        });

        function loadVoices() {
            voices = synth.getVoices();
            const voiceSelect = document.getElementById('voiceSelect');
            if (!voiceSelect) return;
            voiceSelect.innerHTML = '';
            voices.forEach((v, i) => {
                const opt = document.createElement('option');
                opt.value = i; opt.textContent = v.name;
                voiceSelect.appendChild(opt);
            });
        }

        function updateSettings() {
            voiceSettings.index = document.getElementById('voiceSelect').value;
            voiceSettings.rate = document.getElementById('rateRange').value;
        }

        function playStatic() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const buf = ctx.createBuffer(1, ctx.sampleRate * 0.3, ctx.sampleRate);
                const data = buf.getChannelData(0);
                for (let i = 0; i < buf.length; i++) data[i] = Math.random() * 2 - 1;
                const src = ctx.createBufferSource();
                const gn = ctx.createGain();
                src.buffer = buf; gn.gain.value = 0.05;
                src.connect(gn); gn.connect(ctx.destination);
                src.start();
            } catch(e) {}
        }

        async function searchAndFindCategories() {
            const input = document.getElementById('topicInput').value;
            if (!input) return;
            const sRes = await fetch(`https://en.wikipedia.org/w/api.php?action=opensearch&search=${encodeURIComponent(input)}&limit=1&namespace=0&format=json&origin=*`);
            const sData = await sRes.json();
            if (!sData[1].length) return alert("NO DATA FOUND AT THIS ADDRESS");
            
            const correctTitle = sData[1][0];
            const cRes = await fetch(`https://en.wikipedia.org/w/api.php?action=query&prop=categories&titles=${encodeURIComponent(correctTitle)}&cllimit=40&format=json&origin=*`);
            const cData = await cRes.json();
            const pId = Object.keys(cData.query.pages)[0];
            const cats = cData.query.pages[pId].categories || [];
            
            const sel = document.getElementById('categorySelect');
            sel.innerHTML = '';
            
            // --- THE NEW FILTER LOGIC ---
            const bannedWords = ["All Wikipedia", "Articles containing", "All articles", "Articles with"];
            
            const filteredCats = cats.filter(c => {
                const title = c.title.replace('Category:', '');
                return !bannedWords.some(word => title.startsWith(word));
            });

            if (!filteredCats.length) return alert("THE MAINFRAME HAS NO VALID CATEGORIES.");

            filteredCats.forEach(c => {
                const o = document.createElement('option');
                o.value = c.title; 
                o.innerText = c.title.replace('Category:', '');
                sel.appendChild(o);
            });
            showStep(2);
        }

        async function startRadio() {
            const c = document.getElementById('categorySelect').value;
            const res = await fetch(`https://en.wikipedia.org/w/api.php?action=query&list=categorymembers&cmtitle=${encodeURIComponent(c)}&cmlimit=50&format=json&origin=*`);
            const d = await res.json();
            articleList = d.query.categorymembers.filter(a => a.ns === 0);
            showStep(3);
            setupMedia();
            nextArticle();
        }

        async function nextArticle() {
            playStatic();
            synth.cancel();
            if (!articleList.length) return;
            const art = articleList[Math.floor(Math.random() * articleList.length)];
            currentArticleTitle = art.title;
            document.getElementById('nowPlaying').innerText = ">>> NOW TRANSMITTING: " + art.title + " <<<";
            const res = await fetch(`https://en.wikipedia.org/w/api.php?action=query&prop=extracts&exintro&explaintext&titles=${encodeURIComponent(art.title)}&format=json&origin=*`);
            const d = await res.json();
            const txt = d.query.pages[Object.keys(d.query.pages)[0]].extract;
            const ut = new SpeechSynthesisUtterance(txt || "DATA ERROR");
            ut.voice = voices[voiceSettings.index];
            ut.rate = voiceSettings.rate;
            ut.onend = nextArticle;
            synth.speak(ut);
        }

        async function setupMedia() {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.setActionHandler('nexttrack', nextArticle);
                document.getElementById('silenceLoop').play().catch(e => {});
            }
            try { if ('wakeLock' in navigator) { wakeLock = await navigator.wakeLock.request('screen'); } } catch (err) {}
        }

        function favoriteCurrentArticle() {
            if (!currentArticleTitle) return;
            let favs = JSON.parse(localStorage.getItem('wikiFavs') || "[]");
            if (!favs.includes(currentArticleTitle)) {
                favs.push(currentArticleTitle);
                localStorage.setItem('wikiFavs', JSON.stringify(favs));
                updateFavUI();
            }
        }

        function updateFavUI() {
            const list = document.getElementById('favList');
            const favs = JSON.parse(localStorage.getItem('wikiFavs') || "[]");
            list.innerHTML = favs.length ? '<b>* FAVORITE FILES *</b><br>' : '';
            favs.forEach(f => {
                const link = document.createElement('div');
                link.innerHTML = `> <a href="https://en.wikipedia.org/wiki/${encodeURIComponent(f)}" target="_blank">${f}</a>`;
                list.appendChild(link);
            });
        }

        function saveCurrentStation() {
            const cat = document.getElementById('categorySelect').value;
            let favs = JSON.parse(localStorage.getItem('wikiStations') || "[]");
            if (!favs.includes(cat)) { favs.push(cat); localStorage.setItem('wikiStations', JSON.stringify(favs)); updateSavedUI(); }
        }

        function updateSavedUI() {
            const list = document.getElementById('savedList');
            const favs = JSON.parse(localStorage.getItem('wikiStations') || "[]");
            list.innerHTML = favs.length ? '<b>* PRESET STATIONS *</b><br>' : '';
            favs.forEach(f => {
                const b = document.createElement('button');
                b.innerText = f.replace('Category:', '');
                b.onclick = () => { document.getElementById('categorySelect').innerHTML = `<option value="${f}">${f}</option>`; startRadio(); };
                list.appendChild(b);
            });
        }

        function showStep(s) {
            ['step1', 'step2', 'step3'].forEach((id, i) => document.getElementById(id).classList.toggle('hidden', i !== s-1));
        }

        function stopRadio() { 
            synth.cancel(); 
            if (wakeLock) { wakeLock.release(); wakeLock = null; }
            showStep(1); 
        }

        function resetApp() { showStep(1); }
    </script>
</body>
</html>
